server {
    listen 80;
    server_name localhost;
    
    # On définit la racine par défaut (frontend)
    root /var/www/frontend;

    # --- FRONTEND ---
    location / {
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # --- BACKEND (Symfony API) ---
    location /api {
        # On change la racine UNIQUEMENT pour l'API
        alias /var/www/backend/public;
        # Si le fichier n'existe pas, on envoie vers le point d'entrée Symfony
        try_files $uri $uri/ @symfony;
    }

    # On crée un bloc nommé pour gérer Symfony proprement
    location @symfony {
        rewrite ^/api/(.*)$ /index.php/$1 last;
    }

    # --- PHP-FPM ---
    location ~ ^/index\.php(/|$) {
        # C'EST ICI QUE ÇA SE JOUE :
        # On force la racine sur le dossier 'public' du backend
        root /var/www/backend/public;
        
        fastcgi_pass php:9000;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include fastcgi_params;
        
        # SCRIPT_FILENAME sera donc /var/www/backend/public/index.php
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $document_root;
        
        internal;
    }
}